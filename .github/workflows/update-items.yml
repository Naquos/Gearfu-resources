name: Update Items JSON

on:
  workflow_dispatch: # Déclenché manuellement depuis GitHub
  schedule:
    - cron: '0 0 * * 0' # Exécution automatique chaque dimanche à minuit UTC

permissions:
  contents: write # Autoriser le push vers le repo

jobs:
  update-items:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch version from Wakfu API
        id: fetch-version
        run: |
          VERSION=$(curl -s https://wakfu.cdn.ankama.com/gamedata/config.json | jq -r '.version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "✓ Version détectée: $VERSION"

      - name: Download items.json
        run: |
          curl -L -o items.json https://wakfu.cdn.ankama.com/gamedata/${{ steps.fetch-version.outputs.version }}/items.json
          echo "✓ Fichier téléchargé"
          ls -lh items.json

      - name: Download actions.json
        run: |
          curl -L -o actions.json https://wakfu.cdn.ankama.com/gamedata/${{ steps.fetch-version.outputs.version }}/actions.json
          echo "✓ Fichier téléchargé"

      - name: Download states.json
        run: |
          curl -L -o states.json https://wakfu.cdn.ankama.com/gamedata/${{ steps.fetch-version.outputs.version }}/states.json
          echo "✓ Fichier téléchargé"

      - name: Download recipeResults.json
        run: |
          curl -L -o recipeResults.json https://wakfu.cdn.ankama.com/gamedata/${{ steps.fetch-version.outputs.version }}/recipeResults.json
          echo "✓ Fichier téléchargé"

      - name: Download jobItems.json
        run: |
          curl -L -o jobItems.json https://wakfu.cdn.ankama.com/gamedata/${{ steps.fetch-version.outputs.version }}/jobItems.json
          echo "✓ Fichier téléchargé"

      - name: Download recipeIngredients.json
        run: |
          curl -L -o recipeIngredients.json https://wakfu.cdn.ankama.com/gamedata/${{ steps.fetch-version.outputs.version }}/recipeIngredients.json
          echo "✓ Fichier téléchargé"

      - name: Compress all JSON files
        run: |
          gzip -kf items.json
          gzip -kf actions.json
          gzip -kf states.json
          gzip -kf recipeResults.json
          gzip -kf jobItems.json
          gzip -kf recipeIngredients.json
          echo "✓ Compression terminée"
          ls -lh *.json.gz

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add *.json.gz
          git diff --cached --quiet || (
            git commit -m "chore: update gamedata files (version ${{ steps.fetch-version.outputs.version }})"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          )
          echo "✓ Push effectué"
